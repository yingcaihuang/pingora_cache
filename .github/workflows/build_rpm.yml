name: Build RPM Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-rpm:
    name: Build on ${{ matrix.os }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: centos8
            image: rockylinux:8
          - os: centos9
            image: quay.io/centos/centos:stream9
    container:
      image: ${{ matrix.image }}

    steps:
    - name: Install git
      run: dnf install -y git

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        dnf install -y epel-release || true
        dnf install -y rpm-build rpmdevtools rust cargo openssl-devel gcc gcc-c++ make cmake systemd-rpm-macros

    - name: Prepare Source Tarball
      run: |
        # 创建 rpmbuild 目录结构
        rpmdev-setuptree
        
        # 获取版本号 (假设 tag 格式为 v0.1.0)
        VERSION=0.1.0
        NAME=pingora_cache_proxy
        
        # 创建源码目录并打包
        mkdir -p ${NAME}-${VERSION}
        # 复制项目文件到源码目录
        cp -r src Cargo.toml Cargo.lock pingora.service rpm ${NAME}-${VERSION}/
        
        # 打包成 tar.gz
        tar -czf ~/rpmbuild/SOURCES/${NAME}-${VERSION}.tar.gz ${NAME}-${VERSION}

    - name: Build RPM
      run: |
        # 复制 spec 文件到 SPECS 目录
        cp rpm/pingora_cache_proxy.spec ~/rpmbuild/SPECS/
        
        # 执行构建
        rpmbuild -bb ~/rpmbuild/SPECS/pingora_cache_proxy.spec
        
        # 复制构建结果到当前工作目录，方便上传
        mkdir -p rpms
        cp -r ~/rpmbuild/RPMS/* rpms/

    - name: Upload RPM Artifact
      uses: actions/upload-artifact@v4
      with:
        name: pingora-rpm-${{ matrix.os }}
        path: rpms/**/*.rpm

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: rpms/**/*.rpm
